stages:
  - scan_code
  - build
  - docker
  - scan_image
  - release_version
  - terraform
  - terraform_apply

variables:
  DOCKER_BUILDKIT: "1"
  IMAGE_NAME: "docker.io/$DOCKERHUB_USERNAME/$CI_PROJECT_NAME"

# ---------------------------
# üîç CODE SECURITY SCANS
# ---------------------------

# SAST ‚Äî Multi-language static analysis
semgrep_scan:
  stage: scan_code
  image: returntocorp/semgrep:latest
  script:
    - echo "Running Semgrep SAST scan..."
    - semgrep --config p/ci --error --exclude tests/ .
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
# Secret Detection ‚Äî API keys, tokens, creds
gitleaks_scan:
  stage: scan_code
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - echo "Scanning for secrets with Gitleaks..."
    - gitleaks detect --source . --no-banner --exit-code 1
  allow_failure: false
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

# Dockerfile Lint ‚Äî security & efficiency
hadolint_scan:
  stage: scan_code
  image: hadolint/hadolint:latest-debian
  script:
    - hadolint --ignore DL3041 Dockerfile
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  


# ---------------------------
# üß± BUILD STAGE
# ---------------------------
build:
  stage: build
  image: python:3.11
  script:
    - echo "Running build validation..."
    - pip install -r requirements.txt
    - python -m compileall app/
  artifacts:
    paths:
      - app/__pycache__/
    expire_in: 1 hour
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

# ---------------------------
# üê≥ DOCKER BUILD & PUSH (Docker Hub)
# ---------------------------
docker:
  stage: docker
  variables:
    DOCKER_DRIVER: overlay2
  image: docker:29.1.3
  services:
    - docker:dind
  script:
    - |
      echo "Logging into container registry..."
      echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      #Optional: setup Buildx for multi-arch (amd64 + arm64)
      docker buildx create --use
      docker buildx inspect --bootstrap
      
      TAGS="-t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"

      if [ -n "$CI_COMMIT_TAG" ]; then
        TAGS="$TAGS -t $IMAGE_NAME:$CI_COMMIT_TAG"
      fi
      echo "Building and pushing Docker image with tags: $TAGS"
      #docker buildx build --platform linux/amd64 $TAGS --push .
      docker buildx build --platform linux/amd64,linux/arm64 $TAGS --push . 
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  
# ---------------------------
# üß´ IMAGE SECURITY SCAN
# ---------------------------
trivy_scan:
  stage: scan_image
  image:
    name: docker.io/aquasec/trivy:latest
    entrypoint: [""]
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || true
    - trivy config --exit-code 0 . || true
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

docker_release_version:
  stage: release_version
  image: docker:29.1.3
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker manifest inspect "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || exit 1
    - docker pull "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$IMAGE_NAME:$CI_COMMIT_TAG"
    - docker push "$IMAGE_NAME:$CI_COMMIT_TAG"
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_BRANCH == "main"'

# Include Terraform CI configuration
include:
  - local: 'infra/.gitlab-ci.yml'