stages:
  #- scan_code
  #- build
  - docker
  #- scan_image
  - release_version
  - terraform
  - install_addons

variables:
  DOCKER_BUILDKIT: "1"
  IMAGE_NAME: "docker.io/$DOCKERHUB_USERNAME/$CI_PROJECT_NAME"

# ---------------------------
# üîç CODE SECURITY SCANS
# ---------------------------

# SAST ‚Äî Multi-language static analysis
semgrep_scan:
  stage: scan_code
  image: returntocorp/semgrep:latest
  script:
    - echo "Running Semgrep SAST scan..."
    - semgrep --config p/ci --error --exclude tests/ .
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
# Secret Detection ‚Äî API keys, tokens, creds
gitleaks_scan:
  stage: scan_code
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - echo "Scanning for secrets with Gitleaks..."
    - gitleaks detect --source . --no-banner --exit-code 1
  allow_failure: false
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

# Dockerfile Lint ‚Äî security & efficiency
hadolint_scan:
  stage: scan_code
  image: hadolint/hadolint:latest-debian
  script:
    - hadolint --ignore DL3041 Dockerfile
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

# Infrastructure as Code Security ‚Äî Terraform scanning
terrascan_scan:
  stage: scan_code
  image:
    name: tenable/terrascan:latest
    entrypoint: [""]
  script:
    - echo "Initializing Terrascan policies..."
    - terrascan init || echo "Init completed (some policy warnings may occur)"
    - echo "Scanning Terraform files for security issues..."
    - terrascan scan -i terraform -d infra/ || echo "Scan completed with warnings"
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'

# Dependency Vulnerability Scan ‚Äî OWASP Dependency-Check
owasp_dependency_check:
  stage: scan_code
  needs: []
  image:
    name: owasp/dependency-check:latest
    entrypoint: [""]
  script:
    - echo "Scanning Python dependencies for known vulnerabilities..."
    - mkdir -p reports
    - |
      if [ -n "$NVD_API_KEY" ]; then
        /usr/share/dependency-check/bin/dependency-check.sh --scan . --format JSON --format HTML --out reports --enableExperimental --failOnCVSS 7 --project "simple-time-service" --nvdApiKey "$NVD_API_KEY" || true
      else
        echo "Warning: NVD_API_KEY not set. Download will be slower. Get a free key at https://nvd.nist.gov/developers/request-an-api-key"
        /usr/share/dependency-check/bin/dependency-check.sh --scan . --format JSON --format HTML --out reports --enableExperimental --failOnCVSS 7 --project "simple-time-service" || true
      fi
  artifacts:
    paths:
      - reports/
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'

# ---------------------------
# üß± BUILD STAGE
# ---------------------------
build:
  stage: build
  image: python:3.11
  script:
    - echo "Running build validation..."
    - pip install -r requirements.txt
    - python -m compileall app/
  artifacts:
    paths:
      - app/__pycache__/
    expire_in: 1 hour
  rules:
    - if: '$CI_MERGE_REQUEST_ID'  

# ---------------------------
# üê≥ DOCKER BUILD & PUSH (Docker Hub)
# ---------------------------
# Build on MR (any feature branch) - tag with commit SHA
# This image will be reused after merge to main (same commit SHA)
docker:
  stage: docker
  variables:
    DOCKER_DRIVER: overlay2
  image: docker:29.1.3
  services:
    - docker:dind
  script:
    - |
      echo "Logging into container registry..."
      echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      #Optional: setup Buildx for multi-arch (amd64 + arm64)
      docker buildx create --use
      docker buildx inspect --bootstrap
      
      # Always tag with commit SHA (immutable, works for any branch)
      TAGS="-t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"

      # If semantic version tag exists, also tag with that
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAGS="$TAGS -t $IMAGE_NAME:$CI_COMMIT_TAG"
      fi
      
      echo "Building Docker image with commit SHA: $CI_COMMIT_SHORT_SHA"
      echo "Tags: $TAGS"
      #docker buildx build --platform linux/amd64 $TAGS --push .
      docker buildx build --platform linux/amd64,linux/arm64 $TAGS --push . 
  rules:
    # Build on merge requests (any feature branch ‚Üí main)
    - if: '$CI_MERGE_REQUEST_ID'
    # Also build on merge to main (verifies image exists, uses cache if already built)
    - if: '$CI_COMMIT_BRANCH == "main"'
    # Build on semantic version tags (for prod releases)
    - if: '$CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/'  
# ---------------------------
# üß´ IMAGE SECURITY SCAN
# ---------------------------
trivy_scan:
  stage: scan_image
  image:
    name: docker.io/aquasec/trivy:latest
    entrypoint: [""]
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || true
    - trivy config --exit-code 0 . || true
  allow_failure: true
  rules:
    # Scan on merge requests
    - if: '$CI_MERGE_REQUEST_ID'
    # Scan on merge to main
    - if: '$CI_COMMIT_BRANCH == "main"'
    # Scan on semantic version tags
    - if: '$CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/'  

docker_release_version:
  stage: release_version
  image: docker:29.1.3
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker manifest inspect "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || exit 1
    - docker pull "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$IMAGE_NAME:$CI_COMMIT_TAG"
    - docker push "$IMAGE_NAME:$CI_COMMIT_TAG"
  rules:
    - if: '$CI_COMMIT_TAG'

# Include Terraform CI configuration
include:
  - local: 'infra/.gitlab-ci.yml'
  - local: '.gitlab-ci-addons.yml'