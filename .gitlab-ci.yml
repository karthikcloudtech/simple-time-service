stages:
  # - scan_code
  # - build
  - docker
  # - scan_image
  - release_version
  - terraform
  - install_addons

variables:
  DOCKER_BUILDKIT: "1"
  IMAGE_NAME: "docker.io/$DOCKERHUB_USERNAME/$CI_PROJECT_NAME"

# ---------------------------
# ðŸ” CODE SECURITY SCANS
# ---------------------------
# COMMENTED OUT - scan_code stage disabled

# # SAST â€” Multi-language static analysis
# semgrep_scan:
#   stage: scan_code
#   image: returntocorp/semgrep:latest
#   script:
#     - echo "Running Semgrep SAST scan..."
#     - semgrep --config p/ci --error --exclude tests/ .
#   allow_failure: true
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'
# # Secret Detection â€” API keys, tokens, creds
# gitleaks_scan:
#   stage: scan_code
#   image:
#     name: zricethezav/gitleaks:latest
#     entrypoint: [""]
#   script:
#     - echo "Scanning for secrets with Gitleaks..."
#     - gitleaks detect --source . --no-banner --exit-code 1
#   allow_failure: false
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'  

# # Dockerfile Lint â€” security & efficiency
# hadolint_scan:
#   stage: scan_code
#   image: hadolint/hadolint:latest-debian
#   script:
#     - hadolint --ignore DL3041 Dockerfile
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'  

# # Infrastructure as Code Security â€” Terraform scanning
# terrascan_scan:
#   stage: scan_code
#   image:
#     name: tenable/terrascan:latest
#     entrypoint: [""]
#   script:
#     - echo "Initializing Terrascan policies..."
#     - terrascan init || echo "Init completed (some policy warnings may occur)"
#     - echo "Scanning Terraform files for security issues..."
#     - terrascan scan -i terraform -d infra/ || echo "Scan completed with warnings"
#   allow_failure: true
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'

# # Dependency Vulnerability Scan â€” OWASP Dependency-Check
# owasp_dependency_check:
#   stage: scan_code
#   needs: []
#   image:
#     name: owasp/dependency-check:latest
#     entrypoint: [""]
#   script:
#     - echo "Scanning Python dependencies for known vulnerabilities..."
#     - mkdir -p reports
#     - |
#       if [ -n "$NVD_API_KEY" ]; then
#         /usr/share/dependency-check/bin/dependency-check.sh --scan . --format JSON --format HTML --out reports --enableExperimental --failOnCVSS 7 --project "simple-time-service" --nvdApiKey "$NVD_API_KEY" || true
#       else
#         echo "Warning: NVD_API_KEY not set. Download will be slower. Get a free key at https://nvd.nist.gov/developers/request-an-api-key"
#         /usr/share/dependency-check/bin/dependency-check.sh --scan . --format JSON --format HTML --out reports --enableExperimental --failOnCVSS 7 --project "simple-time-service" || true
#       fi
#   artifacts:
#     paths:
#       - reports/
#     expire_in: 1 week
#   allow_failure: true
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'

# ---------------------------
# ðŸ§± BUILD STAGE
# ---------------------------
# COMMENTED OUT - build stage disabled

# build:
#   stage: build
#   image: python:3.11
#   script:
#     - echo "Running build validation..."
#     - pip install -r requirements.txt
#     - python -m compileall app/
#   artifacts:
#     paths:
#       - app/__pycache__/
#     expire_in: 1 hour
#   rules:
#     - if: '$CI_MERGE_REQUEST_ID'  

# ---------------------------
# ðŸ³ DOCKER BUILD & PUSH (Docker Hub)
# ---------------------------
# Build on MR (any feature branch) - tag with commit SHA
# This image will be reused after merge to main (same commit SHA)
docker:
  stage: docker
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: unix:///var/run/docker.sock
    DOCKER_TLS_CERTDIR: ""
  image: docker:29.1.3
  services:
  script:
    - |
      # Debug: Check environment and network connectivity
      echo "=== DEBUG: Environment Variables ==="
      echo "DOCKER_HOST=${DOCKER_HOST:-not set}"
      echo "DOCKER_TLS_CERTDIR=${DOCKER_TLS_CERTDIR:-not set}"
      echo "DOCKER_TLS_VERIFY=${DOCKER_TLS_VERIFY:-not set}"
      echo ""
      echo "=== DEBUG: TLS Certificate Directory ==="
      ls -la /certs/client/ 2>&1 || echo "Certificate directory not found or not accessible"
      echo ""
      echo "=== DEBUG: Check if certificates exist in parent directory ==="
      ls -la /certs/ 2>&1 || echo "Parent certs directory not found"
      echo ""
      echo "=== DEBUG: Network connectivity ==="
      ping -c 2 docker || echo "Cannot ping docker service"
      echo ""
      echo "=== DEBUG: Test port connectivity ==="
      echo "Waiting for dind service to start listening..."
      for i in {1..30}; do
        if nc -zv docker 2375 2>&1 | grep -q "succeeded"; then
          echo "Port 2375 (HTTP) is now accessible after ${i} seconds"
          break
        fi
        echo "Attempt ${i}/30: Port 2375 not ready yet..."
        sleep 1
      done
      nc -zv docker 2375 2>&1 || echo "Port 2375 (HTTP) not accessible after 30 seconds"
      nc -zv docker 2376 2>&1 || echo "Port 2376 (HTTPS) not accessible"
      echo ""
      echo "=== DEBUG: Check privileged mode (if available) ==="
      if [ -c /dev/kmsg ] || [ -w /dev/kmsg ] 2>/dev/null; then
        echo "Privileged mode indicators: /dev/kmsg accessible"
      else
        echo "Privileged mode indicators: /dev/kmsg not accessible (may indicate non-privileged)"
      fi
      echo ""
      echo "=== DEBUG: Docker client version ==="
      docker version --format 'Client: {{.Client.Version}}' || echo "Docker client not available"
      echo ""
      echo "=== DEBUG: Testing HTTP connection (port 2375) ==="
      DOCKER_HOST=tcp://docker:2375 docker info 2>&1 | head -10 || echo "HTTP connection failed"
      echo ""
      echo "=== DEBUG: Testing HTTPS connection (port 2376) ==="
      DOCKER_HOST=tcp://docker:2376 docker info 2>&1 | head -10 || echo "HTTPS connection failed"
      echo ""
      echo "=== DEBUG: Testing default Docker connection (auto-configured) ==="
      docker info 2>&1 | head -10 || echo "Default connection failed"
      echo ""
      echo "Waiting for Docker daemon to be ready..."
      echo "Checking Docker connection..."
      timeout=60
      counter=0
      until docker info > /dev/null 2>&1; do
        if [ $counter -ge $timeout ]; then
          echo "ERROR: Docker daemon did not become ready within ${timeout} seconds"
          echo "=== DEBUG: Final diagnostic ==="
          echo "DOCKER_HOST=${DOCKER_HOST}"
          docker info 2>&1 || true
          echo "=== DEBUG: Testing alternative connections ==="
          docker -H tcp://docker:2375 info 2>&1 | head -10 || true
          docker -H tcp://docker:2376 info 2>&1 | head -10 || true
          echo "This usually means privileged mode is not enabled in the runner config."
          echo "Please check /etc/gitlab-runner/config.toml and ensure privileged = true"
          exit 1
        fi
        echo "Waiting for Docker daemon... (${counter}/${timeout})"
        sleep 1
        counter=$((counter + 1))
      done
      echo "Docker daemon is ready!"
      docker info
      
      echo "Logging into container registry..."
      echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      #Optional: setup Buildx for multi-arch (amd64 + arm64)
      docker buildx create --use
      docker buildx inspect --bootstrap
      
      # Always tag with commit SHA (immutable, works for any branch)
      TAGS="-t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"

      # If semantic version tag exists, also tag with that
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAGS="$TAGS -t $IMAGE_NAME:$CI_COMMIT_TAG"
      fi
      
      echo "Building Docker image with commit SHA: $CI_COMMIT_SHORT_SHA"
      echo "Tags: $TAGS"
      #docker buildx build --platform linux/amd64 $TAGS --push .
      docker buildx build --platform linux/amd64,linux/arm64 $TAGS --push . 
  rules:
    # Build on merge requests (any feature branch â†’ main)
    - if: '$CI_MERGE_REQUEST_ID'
    # Also build on merge to main (verifies image exists, uses cache if already built)
    - if: '$CI_COMMIT_BRANCH == "main"'
    # Build on semantic version tags (for prod releases)
    - if: '$CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/'  
# ---------------------------
# ðŸ§« IMAGE SECURITY SCAN
# ---------------------------
# COMMENTED OUT - scan_image stage disabled

# trivy_scan:
#   stage: scan_image
#   image:
#     name: docker.io/aquasec/trivy:latest
#     entrypoint: [""]
#   script:
#     - echo "Scanning Docker image for vulnerabilities..."
#     - trivy image --exit-code 0 "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || true
#     - trivy config --exit-code 0 . || true
#   allow_failure: true
#   rules:
#     # Scan on merge requests
#     - if: '$CI_MERGE_REQUEST_ID'
#     # Scan on merge to main
#     - if: '$CI_COMMIT_BRANCH == "main"'
#     # Scan on semantic version tags
#     - if: '$CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+\.[0-9]+/'  

docker_release_version:
  stage: release_version
  image: docker:29.1.3
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker manifest inspect "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" || exit 1
    - docker pull "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker tag "$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" "$IMAGE_NAME:$CI_COMMIT_TAG"
    - docker push "$IMAGE_NAME:$CI_COMMIT_TAG"
  rules:
    - if: '$CI_COMMIT_TAG'

# Include Terraform CI configuration
include:
  - local: 'infra/.gitlab-ci.yml'
  - local: '.gitlab-ci-addons.yml'