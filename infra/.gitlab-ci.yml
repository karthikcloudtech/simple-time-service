# ---------------------------
# ðŸ—ï¸ TERRAFORM INFRASTRUCTURE
# ---------------------------


variables:
  TF_ROOT: "infra/environments/prod"
  AWS_DEFAULT_REGION: "us-east-1"
  PROJECT_NAME: "simple-time-service"
  ENVIRONMENT: "prod"
  # Required CI/CD variables:
  # - AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY (or use GitLab OIDC)

terraform_plan:
  stage: terraform
  image: 
    name: hashicorp/terraform:latest
    entrypoint: [""]
  tags:
    - project-specific
  variables:
    TF_ROOT: "infra/environments/prod"
    AWS_DEFAULT_REGION: "us-east-1"
  before_script:
    - cd $TF_ROOT
    - terraform --version
    # Verify required variables are available
    - |
      if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "ERROR: AWS credentials not found. Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as CI/CD variables."
        exit 1
      fi
    - terraform init
  script:
    - echo "Running Terraform plan..."
    - terraform validate
    - terraform plan -out=tfplan -var-file=terraform.tfvars
  artifacts:
    paths:
      - $TF_ROOT/tfplan
      - $TF_ROOT/.terraform
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "infra/**/*"
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "infra/**/*"

terraform_apply:
  stage: terraform
  image: 
    name: hashicorp/terraform:latest
    entrypoint: [""]
  tags:
    - project-specific
  variables:
    TF_ROOT: "infra/environments/prod"
    AWS_DEFAULT_REGION: "us-east-1"
  needs:
    - job: terraform_plan
      optional: true
  before_script:
    # Optionally install AWS CLI, kubectl, and helm (non-blocking - won't prevent terraform destroy)
    - |
      echo "Installing optional tools for EKS addons (failures are non-blocking)..."
      
      # Install required packages for Alpine Linux
      apk add --no-cache curl bash jq unzip openssl ca-certificates python3 py3-pip || true
      
      # Install AWS CLI v1 via pip (v2 installer doesn't work on Alpine/musl)
      # Using --break-system-packages is acceptable in CI/CD environments
      if ! command -v aws &> /dev/null; then
        echo "Installing AWS CLI..."
        pip3 install --no-cache-dir --break-system-packages awscli 2>&1 || echo "AWS CLI installation skipped (non-critical)"
        aws --version 2>&1 || echo "AWS CLI verification skipped"
      else
        echo "AWS CLI already installed: $(aws --version 2>&1)"
      fi
      
      # Install kubectl
      if ! command -v kubectl &> /dev/null; then
        echo "Installing kubectl..."
        KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt 2>/dev/null || echo "v1.28.0")
        curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" 2>&1 || echo "kubectl download skipped"
        chmod +x kubectl 2>/dev/null || true
        mv kubectl /usr/local/bin/kubectl 2>/dev/null || echo "kubectl move skipped"
        kubectl version --client 2>&1 || echo "kubectl verification skipped"
      else
        echo "kubectl already installed: $(kubectl version --client --short 2>&1 || kubectl version --short 2>&1)"
      fi
      
      # Install helm (download tarball directly, no script)
      if ! command -v helm &> /dev/null; then
        echo "Installing helm..."
        HELM_VERSION=$(curl -s https://api.github.com/repos/helm/helm/releases/latest 2>/dev/null | jq -r '.tag_name' || echo "v3.15.0")
        curl -LO "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz" 2>&1 || echo "helm download skipped"
        tar -zxvf "helm-${HELM_VERSION}-linux-amd64.tar.gz" 2>&1 || echo "helm extract skipped"
        mv linux-amd64/helm /usr/local/bin/helm 2>/dev/null || echo "helm move skipped"
        rm -rf "helm-${HELM_VERSION}-linux-amd64.tar.gz" linux-amd64 2>/dev/null || true
        helm version 2>&1 || echo "helm verification skipped"
      else
        echo "helm already installed: $(helm version --short 2>&1 || helm version 2>&1)"
      fi
      
      echo "Tool installation check complete (failures are non-blocking for terraform operations)"
    - cd $TF_ROOT
    - terraform --version
    # Verify required variables are available
    - |
      if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "ERROR: AWS credentials not found. Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as CI/CD variables."
        exit 1
      fi
    - terraform init
  script:
    - echo "Applying Terraform changes..."
    - terraform apply -auto-approve tfplan
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "infra/**/*"
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "infra/**/*"
        

