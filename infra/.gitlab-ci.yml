# ---------------------------
# üèóÔ∏è TERRAFORM INFRASTRUCTURE
# ---------------------------


variables:
  TF_ROOT: "infra/environments/prod"
  AWS_DEFAULT_REGION: "us-east-1"
  PROJECT_NAME: "simple-time-service"
  ENVIRONMENT: "prod"
  # Required CI/CD variables:
  # - AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY (or use GitLab OIDC)

terraform_plan:
  stage: terraform
  image: 
    name: hashicorp/terraform:latest
    entrypoint: [""]
  variables:
    TF_ROOT: "infra/environments/prod"
    AWS_DEFAULT_REGION: "us-east-1"
  before_script:
    - cd $TF_ROOT
    - terraform --version
    # Verify required variables are available
    - |
      if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "ERROR: AWS credentials not found. Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as CI/CD variables."
        exit 1
      fi
    - terraform init
  script:
    - echo "Running Terraform plan..."
    - terraform validate
    - terraform plan -out=tfplan -var-file=terraform.tfvars
  artifacts:
    paths:
      - $TF_ROOT/tfplan
      - $TF_ROOT/.terraform
    expire_in: 1 week
  rules:
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "infra/**/*"
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "infra/**/*"

terraform_apply:
  stage: terraform
  image: 
    name: hashicorp/terraform:latest
    entrypoint: [""]
  variables:
    TF_ROOT: "infra/environments/prod"
    AWS_DEFAULT_REGION: "us-east-1"
  needs:
    - job: terraform_plan
      optional: true
  before_script:
    # Install AWS CLI, kubectl, and helm for addons installation (if needed)
    - |
      # Check if we need these tools (addons installation is enabled by default)
      # Install required packages
      apk add --no-cache curl bash jq unzip
      
      # Install AWS CLI v2
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
      unzip -q /tmp/awscliv2.zip -d /tmp
      /tmp/aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli
      rm -rf /tmp/awscliv2.zip /tmp/aws
      
      # Install kubectl
      KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
      curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
      chmod +x kubectl
      mv kubectl /usr/local/bin/kubectl
      
      # Install helm
      curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      # Configure AWS credentials for aws CLI
      export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
      export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
      export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION}"
    - cd $TF_ROOT
    - terraform --version
    # Verify required variables are available
    - |
      if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
        echo "ERROR: AWS credentials not found. Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as CI/CD variables."
        exit 1
      fi
    - terraform init
  script:
    - echo "Applying Terraform changes..."
    - terraform apply -auto-approve tfplan
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - "infra/**/*"
    - if: '$CI_MERGE_REQUEST_ID'
      changes:
        - "infra/**/*"
        

