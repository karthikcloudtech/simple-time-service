# Separate CI configuration for EKS addons installation
# This job runs once after cluster creation or when manually triggered
# Note: Stage must come after 'terraform' alphabetically to run after infrastructure

variables:
  CLUSTER_NAME: "simple-time-service-${CI_ENVIRONMENT_NAME:-prod}"
  AWS_REGION: "us-east-1"
  PROJECT_NAME: "simple-time-service"

# Install EKS Addons
# This job should run AFTER infrastructure is deployed (terraform apply)
# Can be triggered manually or with INSTALL_ADDONS variable
install_eks_addons:
  stage: install_addons  # Stage defined in main .gitlab-ci.yml, runs after terraform
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script:
    # Install prerequisites
    - apk add --no-cache bash curl jq kubectl helm
    - kubectl version --client
    - helm version
    # Configure AWS credentials
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - aws configure set default.region "$AWS_REGION"
    # Update kubeconfig
    - aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME"
    # Verify connection
    - kubectl cluster-info
  script:
    - |
      chmod +x scripts/install-eks-addons.sh
      CLUSTER_NAME="$CLUSTER_NAME" \
      AWS_REGION="$AWS_REGION" \
      PROJECT_NAME="$PROJECT_NAME" \
      INSTALL_ALB_CONTROLLER="true" \
      INSTALL_ARGOCD="true" \
      INSTALL_METRICS_SERVER="true" \
      INSTALL_CLUSTER_AUTOSCALER="true" \
      bash scripts/install-eks-addons.sh
  rules:
    # Only run on main/develop branches
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      when: manual  # Always requires manual approval for safety
  needs:
    - job: terraform_apply
      optional: true  # Optional so job appears even if terraform_apply wasn't run
  allow_failure: false
  environment:
    name: $CI_ENVIRONMENT_NAME
    action: start
  tags:
    - project-specific

# Quick check job - verify addons are installed
verify_eks_addons:
  stage: install_addons
  image: 
    name: bitnami/kubectl:latest
    entrypoint: [""]
  tags:
    - project-specific
  before_script:
    - apk add --no-cache bash curl
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - aws configure set default.region "$AWS_REGION"
    - aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME"
  script:
    - |
      echo "Verifying EKS addons..."
      echo ""
      echo "=== AWS Load Balancer Controller ==="
      kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller || echo "Not installed"
      echo ""
      echo "=== Metrics Server ==="
      kubectl get pods -n kube-system -l app.kubernetes.io/name=metrics-server || echo "Not installed"
      echo ""
      echo "=== ArgoCD ==="
      kubectl get pods -n argocd || echo "Not installed"
      echo ""
      echo "=== Ingress Classes ==="
      kubectl get ingressclass
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
      when: manual
  needs: []  # Can run independently to verify addons
  allow_failure: true

