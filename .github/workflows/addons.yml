name: Install EKS Addons

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "EKS cluster name"
        required: true
        default: "simple-time-service-prod"
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"
      project_name:
        description: "Project name"
        required: true
        default: "simple-time-service"

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install kubectl and helm
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          curl -LO "https://get.helm.sh/helm-$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq -r '.tag_name')-linux-amd64.tar.gz"
          tar -zxvf helm-*-linux-amd64.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "${{ inputs.aws_region }}" --name "${{ inputs.cluster_name }}"

      - name: Install addons
        run: |
          chmod +x scripts/install-eks-addons.sh
          CLUSTER_NAME="${{ inputs.cluster_name }}" \
          AWS_REGION="${{ inputs.aws_region }}" \
          PROJECT_NAME="${{ inputs.project_name }}" \
          INSTALL_ALB_CONTROLLER="true" \
          INSTALL_ARGOCD="true" \
          INSTALL_METRICS_SERVER="true" \
          INSTALL_CLUSTER_AUTOSCALER="true" \
          bash scripts/install-eks-addons.sh

  verify:
    runs-on: ubuntu-latest
    needs: [install]
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "${{ inputs.aws_region }}" --name "${{ inputs.cluster_name }}"

      - name: Verify addons
        run: |
          echo "Verifying EKS addons..."
          echo "=== AWS Load Balancer Controller ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller || echo "Not installed"
          echo "=== Metrics Server ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=metrics-server || echo "Not installed"
          echo "=== ArgoCD ==="
          kubectl get pods -n argocd || echo "Not installed"
          echo "=== Ingress Classes ==="
          kubectl get ingressclass
