name: Bootstrap ArgoCD

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "scripts/**"
      - "gitops/**"
      - ".github/workflows/addons.yml"
  push:
    branches: [main]
    paths:
      - "scripts/**"
      - "gitops/**"
      - ".github/workflows/addons.yml"
  workflow_dispatch:
    inputs:
      cluster_name:
        description: "EKS cluster name"
        required: true
        default: "simple-time-service-prod"
      aws_region:
        description: "AWS region"
        required: true
        default: "us-east-1"

jobs:
  validate:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck install-eks-addons.sh
        run: shellcheck scripts/install-eks-addons.sh || true

      - name: Validate Helm charts
        run: |
          curl -LO "https://get.helm.sh/helm-$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq -r '.tag_name')-linux-amd64.tar.gz"
          tar -zxvf helm-*-linux-amd64.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          for chart in gitops/helm-charts/*/; do
            for subchart in "$chart"*/; do
              if [ -f "$subchart/Chart.yaml" ]; then
                echo "Validating $subchart..."
                helm lint "$subchart" || true
              fi
            done
          done

      - name: Validate ArgoCD application manifests
        run: |
          for f in gitops/argo-apps/**/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml, sys; yaml.safe_load(open('$f'))" || echo "WARNING: Invalid YAML in $f"
          done

  bootstrap:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install kubectl and helm
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          curl -LO "https://get.helm.sh/helm-$(curl -s https://api.github.com/repos/helm/helm/releases/latest | jq -r '.tag_name')-linux-amd64.tar.gz"
          tar -zxvf helm-*-linux-amd64.tar.gz
          sudo mv linux-amd64/helm /usr/local/bin/helm

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "${{ inputs.aws_region }}" --name "${{ inputs.cluster_name }}"

      - name: Bootstrap ArgoCD
        run: |
          chmod +x scripts/install-eks-addons.sh
          CLUSTER_NAME="${{ inputs.cluster_name }}" \
          AWS_REGION="${{ inputs.aws_region }}" \
          VERBOSE="true" \
          bash scripts/install-eks-addons.sh

  verify:
    runs-on: ubuntu-latest
    needs: [bootstrap]
    if: ${{ github.event_name == 'workflow_dispatch' && always() }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "${{ inputs.aws_region }}" --name "${{ inputs.cluster_name }}"

      - name: Verify bootstrap
        run: |
          echo "Verifying ArgoCD bootstrap..."
          echo "=== AWS Load Balancer Controller ==="
          kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller || echo "Not installed"
          echo ""
          echo "=== ArgoCD ==="
          kubectl get pods -n argocd || echo "Not installed"
          echo ""
          echo "=== ArgoCD Applications ==="
          kubectl get applications -n argocd || echo "No applications yet"
          echo ""
          echo "=== Ingress Classes ==="
          kubectl get ingressclass || echo "No ingress classes"
